<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <title>LINE 貼圖抽獎系統</title>
    <style>
        body { font-family: sans-serif; padding: 20px; max-width: 800px; margin: auto; background: #f4f4f4; }
        .box { background: white; padding: 20px; border-radius: 10px; box-shadow: 0 2px 5px rgba(0,0,0,0.1); margin-bottom: 20px; }
        textarea { width: 100%; height: 200px; box-sizing: border-box; padding: 10px; }
        button { width: 100%; padding: 15px; background: #00c300; color: white; border: none; font-size: 18px; cursor: pointer; border-radius: 5px; }
        .stats { display: flex; justify-content: space-around; margin: 20px 0; background: #eee; padding: 10px; }
        .res-box { display: flex; gap: 10px; }
        .col { flex: 1; background: white; padding: 10px; border: 1px solid #ddd; }
    </style>
</head>
<body>
    <div class="box">
        <h2>LINE 貼圖抽獎</h2>
        <p>請貼上 Excel 清單（姓名 手機）：</p>
        <textarea id="inputList"></textarea>
        <button onclick="draw()">開始抽獎</button>
    </div>

    <div id="result" style="display:none;">
        <div class="stats">
            <div>總筆數：<b id="s1">0</b></div>
            <div>人數：<b id="s2">0</b></div>
            <div>中獎率：<b id="s3">0%</b></div>
        </div>
        <div class="res-box">
            <div class="col"><h3>公布名單</h3><ol id="list1"></ol></div>
            <div class="col"><h3>核對名單</h3><ol id="list2"></ol></div>
        </div>
    </div>

    <script>
        function draw() {
            var text = document.getElementById('inputList').value.trim();
            if(!text) return alert("請輸入名單");
            var lines = text.split('\n');
            var map = {};
            var rawCount = 0;

            lines.forEach(function(l) {
                var p = l.trim().split(/[\s\t]+/);
                if(p.length < 1) return;
                var tel = p[p.length-1].replace(/[^\d]/g, '');
                if(tel.length < 8) return;
                var name = p.length > 1 ? p[0] : "無提供";
                rawCount++;
                if(!map[tel]) map[tel] = {n: name, c: 1};
                else if(map[tel].c < 2) map[tel].c++;
            });

            var pool = [];
            for(var k in map) { for(var i=0; i<map[k].c; i++) pool.push({n:map[k].n, t:k}); }
            
            var winners = [];
            while(winners.length < 100 && pool.length > 0) {
                pool.sort(function(){return Math.random()-0.5});
                var round = [], used = {}, next = [];
                for(var j=0; j<pool.length; j++) {
                    if(!used[pool[j].t] && round.length < (100-winners.length)) {
                        round.push(pool[j]); used[pool[j].t] = 1;
                    } else { next.push(pool[j]); }
                }
                winners = winners.concat(round);
                pool = next;
                if(round.length === 0) break;
            }

            document.getElementById('result').style.display = 'block';
            document.getElementById('s1').innerText = rawCount;
            var uniqueNum = Object.keys(map).length;
            document.getElementById('s2').innerText = uniqueNum;
            document.getElementById('s3').innerText = ((winners.length/uniqueNum)*100).toFixed(1) + "%";

            var l1 = document.getElementById('list1'), l2 = document.getElementById('list2');
            l1.innerHTML = ''; l2.innerHTML = '';
            winners.forEach(function(w) {
                var mName = (w.n.length==2 && /^[\u4E00-\u9FA5]+$/.test(w.n)) ? w.n[0]+"O" : (w.n.length==3 && /^[\u4E00-\u9FA5]+$/.test(w.n)) ? w.n[0]+"O"+w.n[2] : w.n;
                var mTel = w.t.substring(0,4)+"****"+w.t.substring(8);
                l1.innerHTML += "<li>"+mName+" / "+mTel+"</li>";
                l2.innerHTML += "<li>"+w.n+" / "+w.t+"</li>";
            });
        }
    </script>
</body>
</html>
