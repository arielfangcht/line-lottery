<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <title>LINE è²¼åœ–æŠ½çç³»çµ±</title>
    <style>
        body { font-family: "Microsoft JhengHei", sans-serif; padding: 20px; line-height: 1.6; max-width: 900px; margin: auto; background-color: #f9f9f9; }
        .instruction { background: #e8f5e9; padding: 20px; border-left: 5px solid #2e7d32; margin-bottom: 20px; border-radius: 5px; }
        textarea { width: 100%; height: 200px; margin-bottom: 10px; padding: 10px; border: 1px solid #ccc; border-radius: 5px; box-sizing: border-box; font-size: 14px; }
        .result-container { display: flex; gap: 20px; margin-top: 20px; flex-wrap: wrap; }
        .result-box { flex: 1; min-width: 300px; background: white; padding: 15px; border-radius: 5px; border: 1px solid #ddd; box-shadow: 0 2px 5px rgba(0,0,0,0.1); }
        button { padding: 12px 24px; background: #00c300; color: white; border: none; cursor: pointer; border-radius: 5px; font-size: 16px; font-weight: bold; width: 100%; }
        button:hover { background: #009e00; }
        h3 { border-bottom: 2px solid #00c300; padding-bottom: 5px; color: #333; }
        .note { color: #666; font-size: 0.85em; margin-bottom: 10px; }
        ol { padding-left: 25px; }
        li { margin-bottom: 5px; font-family: monospace; }
    </style>
</head>
<body>

    <div class="instruction">
        <h2>ğŸ LINE è²¼åœ–æŠ½çé‚è¼¯èªªæ˜</h2>
        <ul>
            <li><strong>çé …æ•¸é‡ï¼š</strong>å›ºå®š 100 ä»½ã€‚</li>
            <li><strong>æŠ½çæ©Ÿæœƒï¼š</strong>æ¯äºº(æ‰‹æ©Ÿè™Ÿç¢¼)ä¸Šé™ <strong>2 æ¬¡</strong> æ©Ÿæœƒã€‚</li>
            <li><strong>è¦å‰‡ï¼š</strong>æ¯è¼ªæŠ½çè‡ªå‹•å‰”é™¤è©²è¼ªå·²ä¸­çè€…ï¼Œç›´åˆ°æŠ½æ»¿ 100 ä»½æˆ–åå–®ç”¨ç›¡ã€‚</li>
            <li><strong>éš±ç¢¼è¦ç¯„ï¼š</strong>
                <ul>
                    <li>2 å­—ä¸­æ–‡ï¼šéš±ç¢¼ç¬¬ 2 å­—ï¼ˆä¾‹ï¼šç‹Oï¼‰ã€‚</li>
                    <li>3 å­—ä¸­æ–‡ï¼šéš±ç¢¼ç¬¬ 2 å­—ï¼ˆä¾‹ï¼šç‹Oæ˜ï¼‰ã€‚</li>
                    <li><strong>ç„¡æä¾›ï¼š</strong>ç›´æ¥å®Œæ•´å‘ˆç¾ï¼Œä¸éœ€éš±ç¢¼ã€‚</li>
                    <li>å…¶é¤˜æ ¼å¼ï¼šé¡¯ç¤ºå…¨åï¼ˆå¦‚è‹±æ–‡ã€æ³¨éŸ³ã€è¶…é 3 å­—ï¼‰ã€‚</li>
                </ul>
            </li>
        </ul>
    </div>

    <p>è«‹è²¼å…¥åå–®ï¼ˆæ ¼å¼ï¼š<strong>å§“å/æ‰‹æ©Ÿ</strong>ï¼Œä¸€è¡Œä¸€ç­†ï¼‰ï¼š</p>
    <textarea id="inputList" placeholder="ç‹å°æ˜/0912345678&#10;/0988777666 (å§“åç©ºç™½æœƒé¡¯ç¤ºç„¡æä¾›)&#10;ã„…ã„†ã„‡/0911222333"></textarea>
    
    <button onclick="runLottery()">é–‹å§‹æŠ½å– 100 ä»½çé …</button>

    <div id="summary" style="display:none;">
        <h3 id="winnerCount" style="text-align: center; color: #2e7d32; font-size: 24px;"></h3>
        
        <div class="result-container">
            <div class="result-box">
                <h3>ğŸ“¢ å…¬å¸ƒç”¨åå–® (éš±ç¢¼ç‰ˆ)</h3>
                <p class="note">æ‰‹æ©Ÿéš±è—ä¸­é–“ 4 ç¢¼ï¼Œå§“åä¾è¦å‰‡é®è”½ï¼ˆç„¡æä¾›é™¤å¤–ï¼‰ã€‚</p>
                <ol id="maskedList"></ol>
            </div>

            <div class="result-box">
                <h3>ğŸ”‘ æ ¸å°ç”¨åå–® (å®Œæ•´ç‰ˆ)</h3>
                <p class="note">ä¾›å…§éƒ¨ç™¼çå°å¸³ä½¿ç”¨ã€‚</p>
                <ol id="fullList"></ol>
            </div>
        </div>
    </div>

    <script>
        function maskName(name) {
            // å¦‚æœæ˜¯ã€Œç„¡æä¾›ã€ï¼Œç›´æ¥å›å‚³ä¸è™•ç†
            if (name === "ç„¡æä¾›") return name;

            // åˆ¤æ–·æ˜¯å¦ç‚ºç´”ä¸­æ–‡å­—
            const isChinese = /^[\u4E00-\u9FA5]+$/.test(name);
            
            if (isChinese) {
                if (name.length === 2) {
                    return name[0] + "O";
                } else if (name.length === 3) {
                    return name[0] + "O" + name[2];
                }
            }
            return name; // 1å­—ã€æ³¨éŸ³ã€è‹±æ–‡ã€4å­—ä»¥ä¸Šé¡¯ç¤ºåŸæ¨£
        }

        function runLottery() {
            const rawText = document.getElementById('inputList').value.trim();
            if (!rawText) return alert("è«‹è¼¸å…¥åå–®");

            const lines = rawText.split('\n');
            const totalPrizes = 100;
            let winners = [];
            
            // 1. è³‡æ–™è™•ç†
            let participantsMap = {}; 
            lines.forEach(line => {
                if (!line.includes('/')) return;
                let [name, phone] = line.split('/').map(s => s.trim());
                
                if (!phone) return;
                // è‹¥å§“åç‚ºç©ºï¼Œè¨­å®šç‚º "ç„¡æä¾›"
                if (!name || name.length === 0) name = "ç„¡æä¾›";

                if (!participantsMap[phone]) {
                    participantsMap[phone] = { name: name, count: 1 };
                } else if (participantsMap[phone].count < 2) {
                    participantsMap[phone].count++;
                }
            });

            // 2. å»ºç«‹æŠ½çæ± 
            let pool = [];
            for (let phone in participantsMap) {
                for (let i = 0; i < participantsMap[phone].count; i++) {
                    pool.push({ name: participantsMap[phone].name, phone: phone });
                }
            }

            // 3. å¤šè¼ªæŠ½çé‚è¼¯ (ç¢ºä¿æ¯è¼ªä¸é‡è¤‡ï¼Œä¸” 100 ä»½æŠ½å®Œç‚ºæ­¢)
            while (winners.length < totalPrizes && pool.length > 0) {
                let currentRoundWinners = [];
                let roundUsedPhones = new Set();
                let needed = totalPrizes - winners.length;

                // éš¨æ©Ÿæ‰“äº‚æ± å­
                pool.sort(() => Math.random() - 0.5);

                let remainingPool = [];
                for (let i = 0; i < pool.length; i++) {
                    let p = pool[i];
                    if (!roundUsedPhones.has(p.phone) && currentRoundWinners.length < needed) {
                        currentRoundWinners.push(p);
                        roundUsedPhones.add(p.phone);
                    } else {
                        remainingPool.push(p);
                    }
                }
                winners = winners.concat(currentRoundWinners);
                pool = remainingPool;

                if (currentRoundWinners.length === 0) break;
            }

            render(winners);
        }

        function render(winners) {
            document.getElementById('summary').style.display = 'block';
            document.getElementById('winnerCount').innerText = `ğŸ‰ æ­å–œå¾—çè€… (å…± ${winners.length} å)`;

            const fullList = document.getElementById('fullList');
            const maskedList = document.getElementById('maskedList');
            fullList.innerHTML = '';
            maskedList.innerHTML = '';

            winners.forEach(w => {
                // å®Œæ•´ç‰ˆ
                const liF = document.createElement('li');
                liF.textContent = `${w.name} / ${w.phone}`;
                fullList.appendChild(liF);

                // éš±ç¢¼ç‰ˆ
                const liM = document.createElement('li');
                const mName = maskName(w.name);
                // æ‰‹æ©Ÿé®è”½ä¸­é–“ 4 ç¢¼
                const mPhone = w.phone.replace(/(\d{4})(\d{4})(\d{2})/, "$1****$3");
                liM.textContent = `${mName} / ${mPhone}`;
                maskedList.appendChild(liM);
            });

            window.scrollTo({ top: document.getElementById('summary').offsetTop, behavior: 'smooth' });
        }
    </script>
</body>
</html>
